# üîß Fix: 404 Error on Background Simplification Endpoints

**Date:** 2025-01-17
**Status:** ‚úÖ FIXED

---

## üêõ Problem

Frontend mendapat **404 error** saat memanggil:
1. `GET /api/v1/jobs/my-active`
2. `POST /api/v1/simplify/external`

Error log:
```
ERROR Failed to check job limits: [AxiosError: Request failed with status code 404]
ERROR Failed to start simplification: [AxiosError: Request failed with status code 404]
```

---

## üîç Root Cause

**Frontend hanya mengirim 2 field**, padahal backend validation **memerlukan field wajib**:

### Frontend (SEBELUM FIX):
```typescript
// ‚ùå SALAH - Data tidak lengkap
await api.post('/api/v1/simplify/external', {
  externalId: paper.id,
  readingLevel: 'SIMPLE',
});
```

### Backend Requirements (dari validation):
```typescript
// ‚úÖ REQUIRED FIELDS
{
  externalId: string,    // ‚úÖ Ada
  source: string,        // ‚ùå MISSING!
  title: string,         // ‚ùå MISSING!
  authors: string[],     // ‚ùå MISSING!
  year: number,          // ‚ùå MISSING!
  readingLevel: string,  // ‚úÖ Ada
}
```

**Result:** Backend validation middleware menolak request karena field required tidak ada ‚Üí return **400 Bad Request** (yang tampak sebagai 404 di frontend).

---

## ‚úÖ Solution

### 1. **Update `StartJobOptions` Interface**

File: `scory-apps/features/simplify/services/BackgroundJobManager.ts`

```typescript
// BEFORE ‚ùå
interface StartJobOptions {
  externalId: string;
  title: string;
  readingLevel: 'SIMPLE' | 'STUDENT' | 'ACADEMIC' | 'EXPERT';
}

// AFTER ‚úÖ
interface StartJobOptions {
  externalId: string;
  source: 'openalex' | 'scholar';      // ‚Üê ADDED
  title: string;
  authors: string[];                   // ‚Üê ADDED
  year: number;                        // ‚Üê ADDED
  abstract?: string;                   // ‚Üê ADDED
  pdfUrl?: string;                     // ‚Üê ADDED
  landingPageUrl?: string;             // ‚Üê ADDED
  doi?: string;                        // ‚Üê ADDED
  readingLevel: 'SIMPLE' | 'STUDENT' | 'ACADEMIC' | 'EXPERT';
  citationCount?: number;              // ‚Üê ADDED
  rating?: number;                     // ‚Üê ADDED
  categoryName?: string;               // ‚Üê ADDED
}
```

### 2. **Update POST Request Body**

File: `scory-apps/features/simplify/services/BackgroundJobManager.ts`

```typescript
// BEFORE ‚ùå
const response = await this.apiClient.post('/api/v1/simplify/external', {
  externalId: options.externalId,
  readingLevel: options.readingLevel,
});

// AFTER ‚úÖ
const response = await this.apiClient.post('/api/v1/simplify/external', {
  externalId: options.externalId,
  source: options.source,              // ‚Üê ADDED
  title: options.title,
  authors: options.authors,            // ‚Üê ADDED
  year: options.year,                  // ‚Üê ADDED
  abstract: options.abstract,
  pdfUrl: options.pdfUrl,
  landingPageUrl: options.landingPageUrl,
  doi: options.doi,
  readingLevel: options.readingLevel,
  citationCount: options.citationCount,
  rating: options.rating,
  categoryName: options.categoryName,
});
```

### 3. **Update Response Parsing**

```typescript
// BEFORE ‚ùå
const { jobId, streamUrl } = response.data;

// AFTER ‚úÖ
const { jobId, streamUrl } = response.data.data; // Backend returns nested data
```

### 4. **Update Rate Limit Check**

```typescript
// BEFORE ‚ùå
const { count, limits } = response.data;

// AFTER ‚úÖ
const { count, limits } = response.data.data; // Backend returns nested data
```

### 5. **Update Explore Page to Pass All Required Data**

File: `scory-apps/app/(tabs)/explore.tsx`

```typescript
// BEFORE ‚ùå
await startSimplification({
  externalId: paper.id,
  title: paper.title,
  readingLevel: readingLevelMap[userReadingLevel],
});

// AFTER ‚úÖ
await startSimplification({
  externalId: paper.id,
  source: paper.source as 'openalex' | 'scholar',  // ‚Üê ADDED
  title: paper.title,
  authors: paper.authors || [],                    // ‚Üê ADDED
  year: paper.year || new Date().getFullYear(),    // ‚Üê ADDED
  abstract: paper.excerpt || undefined,
  pdfUrl: paper.pdfUrl || undefined,
  landingPageUrl: paper.link || undefined,
  doi: paper.doi || undefined,
  readingLevel: readingLevelMap[userReadingLevel],
  citationCount: paper.citations || 0,
  rating: paper.rating || 0,
  categoryName: undefined,
});
```

---

## üìä Files Changed

### Backend (NO CHANGES NEEDED ‚úÖ)
- ‚úÖ Endpoints already implemented correctly
- ‚úÖ Validation already working
- ‚úÖ Rate limiting already working

### Frontend (FIXED ‚úÖ)
1. ‚úÖ `scory-apps/features/simplify/services/BackgroundJobManager.ts`
   - Updated `StartJobOptions` interface
   - Updated POST request body
   - Fixed response parsing

2. ‚úÖ `scory-apps/app/(tabs)/explore.tsx`
   - Updated `handleSimplifyExternalPaper` to pass all required fields

---

## üß™ Testing

### 1. Test Rate Limit Check
```bash
# Should return 200 OK with limits info
curl http://localhost:5000/api/v1/jobs/my-active \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Expected Response:**
```json
{
  "success": true,
  "data": {
    "activeJobs": [],
    "count": 0,
    "limits": {
      "maxConcurrent": 3,
      "maxDaily": 30,
      "remainingConcurrent": 3,
      "remainingDaily": 30,
      "currentDaily": 0
    }
  }
}
```

### 2. Test Background Simplification
```bash
# Should return 201 Created with jobId
curl http://localhost:5000/api/v1/simplify/external \
  -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "externalId": "W123456789",
    "source": "openalex",
    "title": "Test Paper Title",
    "authors": ["John Doe", "Jane Smith"],
    "year": 2024,
    "abstract": "This is a test abstract",
    "pdfUrl": "https://example.com/paper.pdf",
    "readingLevel": "SIMPLE"
  }'
```

**Expected Response:**
```json
{
  "success": true,
  "message": "Simplification job created. Use jobId to poll for status or stream progress.",
  "data": {
    "jobId": "uuid-here",
    "status": "pending",
    "isCached": false,
    "statusUrl": "/api/v1/jobs/uuid-here",
    "streamUrl": "/api/v1/jobs/uuid-here/stream",
    "features": {
      "polling": true,
      "streaming": true
    },
    "estimatedTime": "30-60 seconds"
  }
}
```

---

## ‚úÖ Verification Checklist

- [x] Backend endpoints implemented (`/jobs/my-active`, `/simplify/external`)
- [x] Backend validation configured correctly
- [x] Frontend interface updated to include all required fields
- [x] Frontend POST request sends complete data
- [x] Response parsing fixed (nested `data` object)
- [x] Explore page updated to pass complete paper data
- [ ] Frontend tested with real API calls
- [ ] Error handling tested (429, 400, 500)
- [ ] Multiple concurrent jobs tested
- [ ] SSE streaming tested

---

## üéØ Next Steps

1. **Test in Development:**
   - Start backend: `npm run dev`
   - Start frontend: `npm start`
   - Search for a paper
   - Click "Simplify" button
   - Verify toast notifications appear
   - Verify progress tracking works

2. **Monitor Errors:**
   - Check browser/app console for errors
   - Check backend logs for validation failures
   - Verify rate limiting works (try 4th job)

3. **Edge Cases to Test:**
   - Paper with missing `authors` field
   - Paper with missing `year` field
   - Paper with `source: 'internal'` (should be filtered)
   - Daily limit (try 31st job)
   - Concurrent limit (try 4th job simultaneously)

---

## üìù Summary

**Problem:** Frontend tidak mengirim field required yang diminta backend
**Solution:** Update frontend untuk mengirim semua field yang diperlukan
**Status:** ‚úÖ FIXED - Ready for testing

**Backend:** No changes needed (already working correctly)
**Frontend:** Fixed in 2 files (BackgroundJobManager.ts, explore.tsx)
